# 直方图均衡化报告

> 元凯文 	200110213

### 1. 项目内容

分析图像中灰度的分布，利用直方图均衡化的方法对图像进行增强

### 2. 方法描述

使用直方图均衡化的均匀分布算法，主要步骤如下：

1. 统计原始图像各灰度级的像素数目ni,0≤i<L, L是图像中所有的灰度数(本例中为256)；

2. 图像中灰度为i的像素的出现概率是:px(i)=p(x=i)=ni/n，n是图像中所有的像素数

3. 计算px的累积分布函数cdfx：

   <img src="https://img-blog.csdn.net/20180128172908714" alt="img" style="zoom:80%;" />

   > 程序中为方便cdf函数与直方图一起显示，将cdf函数归一化到[0,L-1]

4. 直方图均衡化计算公式, cdfmin为累积分布函数最小值，M和N分别代表了图像的长宽像素个数（程序中以cdfmax代替像素总数计算），round表示对结果取整（直方图离散），h(v)为原始图像中为灰度值为v的像素点经过映射后新的灰度值：

   <img src="https://img-blog.csdn.net/20180128172936230" alt="img" style="zoom:80%;" />

————————————————

参考资料：

1. [wiki][] 
2. [openCV doc][]

### 3. 结果和分析

+ 均衡化前后直方图和累积归一函数对比：

  <img src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20210916220034362.png" alt="image-20210916220034362" style="zoom:80%;" />

+ 均衡化前后灰度图对比：

  <img src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20210916222029860.png" alt="image-20210916222029860" style="zoom: 50%;" />



<img src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20210916222311728.png" alt="image-20210916222311728" style="zoom:50%;" />

+ 算法优点

  对于弱对比度灰度图的均衡化效果非常明显

+ 算法缺点

  结果图像中，右侧教学楼的对比度被过分增强，此算法在局部处理上仍有缺陷，针对此，可先对小区域执行算法后合并，也可考虑瑞利分布、指数分布等其他分布方法，亦可结合其他局部算法进行诸如光照分析等综合分析。

### 4. 总结

+ 难点

  之前准备数模时对numpy/matplotlib/scipy/pandas等三方库已经有一定了解，再者因为爱好摄影，对数字图像诸如色彩空间、通道、直方图等概念也比较熟悉，所以这次任务最主要的难点还是在理解这个均衡化方程上，过程中看到 [图像直方图均衡化和规定化是怎么做的?][] 这篇文章里面指出当映射方程满足如下关系时灰度图会被完美均衡化（非离散）：

  <img src="https://www.zhihu.com/equation?tex=S_f%28r%29+%3D+S_g%5BT%28r%29%5D+%5CLeftrightarrow+S_f%28r%29+%3D+S_g%28s%29+%5C+%5C+%5Ccdots+%5Ccdots%281%29" alt="[公式]" style="zoom:150%;" />

  并且给出了证明，基于此可推导出本算法步骤(4)中的映射方程：

  <img src="C:\Users\86186\AppData\Roaming\Typora\typora-user-images\image-20210916235220435.png" alt="image-20210916235220435" style="zoom: 33%;" />

  由此可以得到h(v)方程的斜率，再考虑到对于高短调图片而言，可能会出现Cdf(i)=0 (i<=某较小值) 的情况，而对这些灰度值进行映射无意义，因此引入Cdfmin，处理后即得步骤(4)中公式

+ 所学知识

  在没有开始做任务之前的openCV学习阶段，常常联想那些曾经学CameraRaw和PS时学得一知半解的操作，曲线、混合器之类的，感觉用算法来解释一下子清晰了，这可能是这次任务最大的收获。做完任务试着把任务图片丢到PS里自动色阶了一下，突然发现PS的自动色阶的均衡化算法跟用本算法跑出来的相比还是蛮保守的，可能遵循的原则是尽量在改动的同时让片子越 'raw' 越好吧。

















[wiki]:https://en.wikipedia.org/wiki/Histogram_equalization#:~:text=Histogram%20equalization%20accomplishes%20this%20by,use%20to%20degrade%20image%20contrast.&text=So%20in%20theory%2C%20if%20the,original%20histogram%20can%20be%20recovered
[openCV doc]:https://docs.opencv.org/master/d5/daf/tutorial_py_histogram_equalization.html
[图像直方图均衡化和规定化是怎么做的?]: https://www.zhihu.com/question/37204742/answer/221844779